name: Build NPU RPC Bridge
on: [push]

jobs:
  build-bridge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout TVM
        uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          submodules: 'recursive'
          path: 'tvm'

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          ndk-version: 26.1.10909125

      - name: Build Android CPU RPC (Proxy)
        run: |
          cd tvm
          mkdir build_android && cd build_android
          
          # THE FIX: Force CMake Policy and Bypass Compiler Check
          # This stops the 'Configuring incomplete' AHHHHHHHH error
          cmake .. \
            -DCMAKE_POLICY_DEFAULT_CMP0000=NEW \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK_ROOT \
            -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
            -DCMAKE_ANDROID_STL_TYPE=c++_static \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-28 \
            -DUSE_CPP_RPC=ON \
            -DUSE_HEXAGON=ON \
            -DUSE_LIBBACKTRACE=OFF
          
          make tvm_rpc -j$(nproc)

      - name: Build Hexagon NPU Runtime (Skeleton)
        run: |
          cd tvm
          # Use the root build to generate the Hexagon Skel
          # 2026 requires the HEXAGON_RPC_SKEL target explicitly
          mkdir build_hexagon && cd build_hexagon
          
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DUSE_HEXAGON_RPC=ON \
            -DUSE_HEXAGON_ARCH=v75
            
          make hexagon_rpc_skel -j$(nproc)

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: npu-bridge-2026
          path: |
            tvm/build_android/tvm_rpc
            tvm/build_hexagon/libhexagon_rpc_skel.so
