name: Build NPU RPC Bridge
on: [push]

jobs:
  manual-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          submodules: 'recursive'
          path: 'tvm'

      - name: Setup NDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          ndk-version: 26.1.10909125

      - name: Manual Compile RPC Server
        run: |
          # Define paths
          NDK_TOOLCHAIN=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin
          export PATH=$NDK_TOOLCHAIN:$PATH
          
          cd tvm/apps/cpp_rpc
          
          # Compile the RPC server directly using NDK Clang
          # This skips all the CMake 'TryCompile' bullshit
          aarch64-linux-android34-clang++ -O3 -std=c++17 \
            -I../../include \
            -I../../3rdparty/dmlc-core/include \
            -I../../3rdparty/rang/include \
            main.cc rpc_server.cc \
            -o tvm_rpc \
            -llog -v
            
      - name: Manual Compile Hexagon Skeleton
        run: |
          cd tvm/src/runtime/hexagon/rpc
          # This compiles the HTP bridge skeleton
          # We use the HTP-specific headers from the TVM tree
          aarch64-linux-android34-clang++ -O3 -shared -fPIC \
            -I../../../../include \
            -I../../../../src/runtime/hexagon \
            hexagon_rpc_skel.cc \
            -o libhexagon_rpc_skel.so
            
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: bridge-binaries
          path: |
            tvm/apps/cpp_rpc/tvm_rpc
            tvm/src/runtime/hexagon/rpc/libhexagon_rpc_skel.so
