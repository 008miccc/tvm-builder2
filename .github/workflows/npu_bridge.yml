name: Build NPU RPC Bridge
on: [push]

jobs:
  build-bridge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout TVM
        uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          submodules: 'recursive'
          path: 'tvm'

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          ndk-version: 26.1.10909125

      - name: Build Android CPU RPC (Proxy)
        run: |
          cd tvm
          mkdir build_android && cd build_android
          
          # THE FIX: Explicitly disable the new 2026 CMake Toolchain logic 
          # which causes the -fuse-ld=lld explosion.
          cmake .. \
            -DANDROID_USE_LEGACY_TOOLCHAIN_FILE=ON \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-28 \
            -DUSE_CPP_RPC=ON \
            -DUSE_HEXAGON=ON \
            -DUSE_LIBBACKTRACE=OFF
          
          make tvm_rpc -j$(nproc)

      - name: Build Hexagon NPU Skeleton
        run: |
          cd tvm
          mkdir build_hexagon && cd build_hexagon
          
          # Same fix for the NPU side
          cmake .. \
            -DANDROID_USE_LEGACY_TOOLCHAIN_FILE=ON \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DUSE_HEXAGON_RPC=ON \
            -DUSE_HEXAGON_ARCH=v75
            
          make hexagon_rpc_skel -j$(nproc)

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: npu-bridge-2026
          path: |
            tvm/build_android/tvm_rpc
            tvm/build_hexagon/libhexagon_rpc_skel.so
